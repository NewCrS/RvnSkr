<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√¨nh ƒê·ªçc Truy·ªán PDF Cao C·∫•p</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        :root { 
            --sidebar-w: 300px; 
            --accent: #3b82f6; 
            --bg-main: #ffffff;
            --bg-sidebar: #ffffff;
            --text-color: #000000;
            --item-hover: #fcfcfc;
            --border-color: #eeeeee;
            --btn-toggle-color: rgba(0, 0, 0, 0.7);
            --pdf-filter: none;
        }

        [data-theme="dark"] {
            --bg-main: #121212;
            --bg-sidebar: #1e1e1e;
            --text-color: #e0e0e0;
            --item-hover: #2d2d2d;
            --border-color: #333333;
            --btn-toggle-color: rgba(255, 255, 255, 0.8);
            --pdf-filter: invert(0.9) hue-rotate(180deg) brightness(1.1) contrast(1.1);
        }

        body { 
            margin: 0; 
            display: flex; 
            height: 100vh; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: var(--bg-main); 
            color: var(--text-color); 
            overflow: hidden; 
            transition: background 0.3s ease; 
        }
        
        /* N√∫t 3 g·∫°ch */
        #menu-toggle {
            position: fixed; top: 15px; left: 15px; z-index: 1100;
            background: transparent; color: var(--btn-toggle-color);
            border: none; font-size: 35px; cursor: pointer; padding: 5px; line-height: 1; 
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); user-select: none;
        }
        #menu-toggle:hover { transform: scale(1.1); color: var(--accent); }

        /* Sidebar c·ªë ƒë·ªãnh - Kh√¥ng ƒë·∫©y n·ªôi dung truy·ªán */
        #sidebar { 
            position: fixed; top: 0; left: 0; bottom: 0;
            width: var(--sidebar-w); background: var(--bg-sidebar); 
            overflow: hidden; display: flex; flex-direction: column;
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            z-index: 1000; border-right: 1px solid var(--border-color);
            box-shadow: 10px 0 30px rgba(0,0,0,0.05);
            will-change: transform;
        }
        #sidebar.hidden { transform: translateX(-100%); box-shadow: none; }

        .sidebar-header { padding: 70px 25px 20px; font-weight: bold; border-bottom: 1px solid var(--border-color); font-size: 1.2rem; letter-spacing: 0.5px; }
        #list { flex-grow: 1; overflow-y: auto; scrollbar-width: thin; }

        .chapter-item { padding: 18px 25px; border-bottom: 1px solid var(--border-color); cursor: pointer; color: var(--text-color); transition: 0.2s; font-size: 0.95rem; }
        .chapter-item:hover { background: var(--item-hover); color: var(--accent); }
        .chapter-item.active { background: rgba(59, 130, 246, 0.12); color: var(--accent); border-left: 5px solid var(--accent); font-weight: bold; }

        .sidebar-footer { padding: 20px; border-top: 1px solid var(--border-color); background: var(--bg-sidebar); }
        #theme-btn {
            width: 100%; padding: 12px; border: 1px solid var(--border-color);
            background: var(--bg-sidebar); color: var(--text-color);
            border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 12px; font-weight: 500; transition: 0.3s;
        }
        #theme-btn:hover { border-color: var(--accent); background: var(--item-hover); }

        /* Viewer Area */
        #main-viewer { 
            width: 100%; height: 100vh;
            overflow-y: auto; display: flex; flex-direction: column; align-items: center; 
            background: var(--bg-main); transition: background 0.3s ease; 
            scrollbar-gutter: stable;
        }
        #pdf-render-container { width: 100%; max-width: 900px; margin: 20px 0; padding: 0 15px; box-sizing: border-box; }
        
        /* Canvas PDF S·∫Øc N√©t */
        canvas { 
            display: block; margin: 0 auto 30px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.12); 
            max-width: 100%; height: auto !important; 
            filter: var(--pdf-filter);
            background: white;
            transition: filter 0.4s ease;
            /* Kh·ª≠ m·ªù tuy·ªát ƒë·ªëi */
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }
        
        #loading { color: var(--text-color); margin-top: 120px; font-size: 1rem; font-weight: 600; text-transform: uppercase; opacity: 0.7; }

        @media (max-width: 768px) {
            #pdf-render-container { margin-top: 70px; }
            --sidebar-w: 85%;
        }
    </style>
</head>
<body>

<button id="menu-toggle" title="M·ªü danh s√°ch">‚ò∞</button>

<div id="sidebar" class="hidden">
    <div class="sidebar-header">DANH S√ÅCH T·∫¨P</div>
    <div id="list">ƒêang qu√©t d·ªØ li·ªáu...</div>
    <div class="sidebar-footer">
        <button id="theme-btn">
            <span id="theme-icon">üåô</span> <span id="theme-text">Ch·∫ø ƒë·ªô t·ªëi</span>
        </button>
    </div>
</div>

<div id="main-viewer">
    <div id="loading" style="display: none;">ƒêang t·ªëi ∆∞u ƒë·ªô n√©t...</div>
    <div id="pdf-render-container"></div>
</div>

<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    const sidebar = document.getElementById('sidebar');
    const menuToggle = document.getElementById('menu-toggle');
    const themeBtn = document.getElementById('theme-btn');
    const themeIcon = document.getElementById('theme-icon');
    const themeText = document.getElementById('theme-text');
    const listEl = document.getElementById('list');
    const container = document.getElementById('pdf-render-container');
    const loadingStatus = document.getElementById('loading');

    // Qu·∫£n l√Ω Giao di·ªán
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    updateThemeUI(savedTheme);

    themeBtn.onclick = () => {
        let theme = document.documentElement.getAttribute('data-theme');
        let newTheme = theme === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeUI(newTheme);
    };

    function updateThemeUI(theme) {
        themeIcon.innerText = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        themeText.innerText = theme === 'dark' ? 'Ch·∫ø ƒë·ªô s√°ng' : 'Ch·∫ø ƒë·ªô t·ªëi';
    }

    // X·ª≠ l√Ω Menu m∆∞·ª£t m√†
    menuToggle.onclick = (e) => {
        sidebar.classList.toggle('hidden');
        e.stopPropagation();
    };

    document.getElementById('main-viewer').onclick = () => {
        if (!sidebar.classList.contains('hidden')) sidebar.classList.add('hidden');
    };

    // N·∫°p danh s√°ch truy·ªán
    fetch('assets/novel/index.json')
        .then(res => res.json())
        .then(data => {
            listEl.innerHTML = '';
            data.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'chapter-item';
                div.textContent = item.title;
                div.onclick = (e) => {
                    e.stopPropagation();
                    loadPDF('assets/novel/' + item.file, div);
                    sidebar.classList.add('hidden');
                };
                listEl.appendChild(div);
                if(index === 0) loadPDF('assets/novel/' + item.file, div);
            });
        });

    // H√†m render PDF si√™u n√©t
    async function loadPDF(url, element) {
        document.querySelectorAll('.chapter-item').forEach(el => el.classList.remove('active'));
        element.classList.add('active');
        
        container.innerHTML = '';
        loadingStatus.style.display = 'block';
        document.getElementById('main-viewer').scrollTop = 0;

        try {
            const pdf = await pdfjsLib.getDocument(url).promise;
            loadingStatus.style.display = 'none';

            // D√πng t·ªâ l·ªá ƒëi·ªÉm ·∫£nh cao (DPR)
            const dpr = window.devicePixelRatio || 1;
            // TƒÉng scale l√™n 2.0 - 2.2 ƒë·ªÉ n·∫°p d·ªØ li·ªáu chi ti·∫øt h∆°n
            const baseScale = 2.2; 

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: baseScale });
                
                const canvas = document.createElement('canvas');
                container.appendChild(canvas);
                const context = canvas.getContext('2d');

                // TƒÉng k√≠ch th∆∞·ªõc v·∫Ω n·ªôi b·ªô d·ª±a tr√™n DPR
                canvas.width = Math.floor(viewport.width * dpr);
                canvas.height = Math.floor(viewport.height * dpr);
                
                // √âp k√≠ch th∆∞·ªõc hi·ªÉn th·ªã chu·∫©n theo CSS
                canvas.style.width = viewport.width + "px";
                canvas.style.height = "auto";

                // Kh·ª≠ m·ªù n·ªôi b·ªô context
                context.imageSmoothingEnabled = false;
                context.webkitImageSmoothingEnabled = false;
                context.scale(dpr, dpr);

                await page.render({
                    canvasContext: context,
                    viewport: viewport,
                    intent: 'print' // √âp PDF.js s·ª≠ d·ª•ng b·ªô d·ª±ng h√¨nh ch·∫•t l∆∞·ª£ng in ·∫•n
                }).promise;
            }
        } catch (err) {
            loadingStatus.innerText = "L·ªñI N·∫†P FILE TRUY·ªÜN.";
            console.error(err);
        }
    }
</script>

</body>
</html>
