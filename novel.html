<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√¨nh ƒê·ªçc Truy·ªán PDF S·∫Øc N√©t</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        :root { 
            --sidebar-w: 280px; 
            --accent: #3b82f6; 
            --bg-main: #ffffff;
            --bg-sidebar: #ffffff;
            --text-color: #000000;
            --item-hover: #fcfcfc;
            --border-color: #eeeeee;
            --btn-toggle-color: rgba(0, 0, 0, 0.7);
            --pdf-filter: none;
        }

        [data-theme="dark"] {
            --bg-main: #1a1a1a;
            --bg-sidebar: #252525;
            --text-color: #e0e0e0;
            --item-hover: #333333;
            --border-color: #444444;
            --btn-toggle-color: rgba(255, 255, 255, 0.8);
            /* B·ªô l·ªçc ƒë·∫£o m√†u PDF th√¥ng minh */
            --pdf-filter: invert(0.9) hue-rotate(180deg) brightness(1.1) contrast(1.1);
        }

        body { margin: 0; display: flex; height: 100vh; font-family: -apple-system, sans-serif; background: var(--bg-main); color: var(--text-color); overflow: hidden; transition: background 0.3s; }
        
        /* N√∫t 3 g·∫°ch ƒëen trong su·ªët */
        #menu-toggle {
            position: fixed; top: 10px; left: 15px; z-index: 1000;
            background: transparent; color: var(--btn-toggle-color);
            border: none; font-size: 35px; cursor: pointer; padding: 5px; line-height: 1; transition: 0.3s; user-select: none;
        }
        #menu-toggle:hover { transform: scale(1.1); }

        /* Sidebar */
        #sidebar { 
            width: var(--sidebar-w); background: var(--bg-sidebar); 
            overflow: hidden; flex-shrink: 0; display: flex; flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 999; border-right: 1px solid var(--border-color);
        }
        #sidebar.hidden { transform: translateX(-100%); position: absolute; height: 100%; }

        .sidebar-header { padding: 60px 20px 20px; font-weight: bold; border-bottom: 1px solid var(--border-color); font-size: 1.1rem; }
        #list { flex-grow: 1; overflow-y: auto; }

        .chapter-item { padding: 15px 20px; border-bottom: 1px solid var(--border-color); cursor: pointer; color: var(--text-color); transition: 0.2s; }
        .chapter-item:hover { background: var(--item-hover); color: var(--accent); }
        .chapter-item.active { background: rgba(59, 130, 246, 0.1); color: var(--accent); border-left: 4px solid var(--accent); font-weight: bold; }

        .sidebar-footer { padding: 15px; border-top: 1px solid var(--border-color); }
        #theme-btn {
            width: 100%; padding: 12px; border: 1px solid var(--border-color);
            background: var(--bg-sidebar); color: var(--text-color);
            border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.3s;
        }

        /* Viewer Area */
        #main-viewer { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; align-items: center; background: var(--bg-main); transition: background 0.3s; }
        #pdf-render-container { width: 100%; max-width: 950px; margin-top: 20px; padding: 0 10px; box-sizing: border-box; }
        
        /* Canvas hi·ªÉn th·ªã PDF */
        canvas { 
            display: block; margin: 0 auto 20px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            max-width: 100%; height: auto !important; 
            filter: var(--pdf-filter);
            transition: filter 0.3s ease;
            background: white; /* ƒê·∫£m b·∫£o c√≥ n·ªÅn tr·∫Øng tr∆∞·ªõc khi l·ªçc */
        }
        
        #loading { color: var(--text-color); margin-top: 100px; font-size: 0.9rem; font-weight: bold; letter-spacing: 1px; }

        @media (max-width: 768px) {
            #sidebar { position: absolute; height: 100%; box-shadow: 10px 0 30px rgba(0,0,0,0.2); }
            #pdf-render-container { margin-top: 60px; }
        }
    </style>
</head>
<body>

<button id="menu-toggle">‚ò∞</button>

<div id="sidebar" class="hidden">
    <div class="sidebar-header">DANH S√ÅCH T·∫¨P</div>
    <div id="list">ƒêang t·∫£i danh s√°ch...</div>
    <div class="sidebar-footer">
        <button id="theme-btn">
            <span id="theme-icon">üåô</span> <span id="theme-text">Ch·∫ø ƒë·ªô t·ªëi</span>
        </button>
    </div>
</div>

<div id="main-viewer">
    <div id="loading" style="display: none;">ƒêANG X·ª¨ L√ù N·ªòI DUNG...</div>
    <div id="pdf-render-container"></div>
</div>

<script>
    // Ch·ªâ ƒë·ªãnh Worker ƒë√∫ng phi√™n b·∫£n
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    const sidebar = document.getElementById('sidebar');
    const menuToggle = document.getElementById('menu-toggle');
    const themeBtn = document.getElementById('theme-btn');
    const themeIcon = document.getElementById('theme-icon');
    const themeText = document.getElementById('theme-text');
    const listEl = document.getElementById('list');
    const container = document.getElementById('pdf-render-container');
    const loadingStatus = document.getElementById('loading');

    // 1. Qu·∫£n l√Ω Ch·ªß ƒë·ªÅ (Theme)
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    updateThemeUI(savedTheme);

    themeBtn.onclick = () => {
        let theme = document.documentElement.getAttribute('data-theme');
        let newTheme = theme === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeUI(newTheme);
    };

    function updateThemeUI(theme) {
        if (theme === 'dark') {
            themeIcon.innerText = '‚òÄÔ∏è';
            themeText.innerText = 'Ch·∫ø ƒë·ªô s√°ng';
        } else {
            themeIcon.innerText = 'üåô';
            themeText.innerText = 'Ch·∫ø ƒë·ªô t·ªëi';
        }
    }

    // 2. ƒêi·ªÅu h∆∞·ªõng Menu
    menuToggle.onclick = (e) => {
        sidebar.classList.toggle('hidden');
        e.stopPropagation();
    };

    document.getElementById('main-viewer').onclick = () => {
        if (window.innerWidth <= 768) sidebar.classList.add('hidden');
    };

    // 3. T·∫£i danh s√°ch t·ª´ index.json
    fetch('assets/novel/index.json')
        .then(res => res.json())
        .then(data => {
            listEl.innerHTML = '';
            data.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'chapter-item';
                div.textContent = item.title;
                div.onclick = () => {
                    loadPDF('assets/novel/' + item.file, div);
                    if (window.innerWidth <= 768) sidebar.classList.add('hidden');
                };
                listEl.appendChild(div);
                // Load file ƒë·∫ßu ti√™n m·∫∑c ƒë·ªãnh
                if(index === 0) loadPDF('assets/novel/' + item.file, div);
            });
        })
        .catch(err => {
            listEl.innerHTML = '<div style="padding:20px; color:red;">L·ªói t·∫£i d·ªØ li·ªáu.</div>';
        });

    // 4. H√†m v·∫Ω PDF s·∫Øc n√©t (Hi-DPI support)
    async function loadPDF(url, element) {
        // Highlight ch∆∞∆°ng ƒëang ch·ªçn
        document.querySelectorAll('.chapter-item').forEach(el => el.classList.remove('active'));
        element.classList.add('active');
        
        // Reset container & Scroll
        container.innerHTML = '';
        loadingStatus.style.display = 'block';
        document.getElementById('main-viewer').scrollTop = 0;

        try {
            const pdf = await pdfjsLib.getDocument(url).promise;
            loadingStatus.style.display = 'none';

            // L·∫•y t·ªâ l·ªá m·∫≠t ƒë·ªô ƒëi·ªÉm ·∫£nh c·ªßa m√†n h√¨nh (v√≠ d·ª• Retina = 2)
            const dpr = window.devicePixelRatio || 1;

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                
                // TƒÉng scale th√™m 20% (1.5 -> 1.8)
                const baseScale = 1.8;
                const viewport = page.getViewport({ scale: baseScale });
                
                const canvas = document.createElement('canvas');
                container.appendChild(canvas);
                const context = canvas.getContext('2d');

                // K·ªπ thu·∫≠t x·ª≠ l√Ω s·∫Øc n√©t: 
                // Nh√¢n ƒë√¥i k√≠ch th∆∞·ªõc v·∫Ω th·ª±c t·∫ø, sau ƒë√≥ d√πng CSS thu nh·ªè l·∫°i
                canvas.width = viewport.width * dpr;
                canvas.height = viewport.height * dpr;
                canvas.style.width = viewport.width + "px";
                canvas.style.height = viewport.height + "px";

                context.scale(dpr, dpr);

                await page.render({
                    canvasContext: context,
                    viewport: viewport
                }).promise;
            }
        } catch (err) {
            console.error(err);
            loadingStatus.innerText = "KH√îNG TH·ªÇ M·ªû FILE PDF. H√ÉY KI·ªÇM TRA T√äN FILE TR√äN GITHUB!";
        }
    }
</script>

</body>
</html>
